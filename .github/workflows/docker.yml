name: Docker nginx lab

on:
    pull_request:
        types: [closed]
        branches:
            - main
jobs:
    docker:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4 
            
            - name: Login to dockerhub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build docker image
              run: docker build -t mynginx:test .

            - name: Test docker image
              run: |
                docker run -d -p 8080:80 --name test-nginx mynginx:test
                sleep 5
                curl http://localhost:8080 | grep "Hello from GitHub Actions!""
                docker stop test-nginx

            - name: Push to Dockerhub
              run: |
                docker tag mynginx:test ${{ secrets.DOCKER_USERNAME }}/mynginx:latest
                docker push ${{ secrets.DOCKER_USERNAME }}/mynginx:latest